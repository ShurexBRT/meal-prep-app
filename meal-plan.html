<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <title>Planer obroka • Smart Meal Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8fdf6;
      }
      .home-button {
        position: fixed;
        top: 15px;
        right: 15px;
        background-color: #e0f7e9;
        padding: 8px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        color: #2b7a4b;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
      }
      .home-button:hover {
        background-color: #c0ebd2;
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="home-button">🏠 Home</a>

    <div class="container py-4">
      <h1 class="text-success mb-4">📆 Nedeljni plan obroka</h1>

      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>Dan</th>
              <th>Doručak</th>
              <th>Užina</th>
              <th>Ručak</th>
              <th>VeĎra</th>
            </tr>
          </thead>
          <tbody id="mealPlanTable"></tbody>
        </table>
      </div>

      <div class="d-flex gap-3 mt-4">
        <button class="btn btn-outline-primary" onclick="saveMealPlan()">💾 Sačuvaj plan</button>
        <button class="btn btn-outline-warning" onclick="generateShoppingList()">🛒 Lista za kupovinu</button>
      </div>

      <p class="mt-3 text-success d-none" id="saveMessage">✅ Plan sačuvan!</p>

      <a href="index.html" class="btn btn-outline-dark mt-4">← Nazad na početnu</a>
    </div>

    <script>
      const days = ['Ponedeljak', 'Utorak', 'Sreda', 'Četvrtak', 'Petak', 'Subota', 'Nedelja'];
      const meals = ['dorucak', 'uzina', 'rucak', 'vecera'];
      const table = document.getElementById('mealPlanTable');
      const saveMsg = document.getElementById('saveMessage');
      let allRecipes = [];

      fetch('/meal-prep-app/data/recipes.json')
        .then(res => res.json())
        .then(data => {
          allRecipes = data;
          renderTable();
        });

      function normalizeKategorija(str) {
        return str.trim().toLowerCase();
      }

      function renderTable() {
        const savedPlan = getSavedPlan();

        table.innerHTML = '';

        days.forEach((day) => {
          const tr = document.createElement('tr');
          const tdDay = document.createElement('td');
          tdDay.textContent = day;
          tr.appendChild(tdDay);

          meals.forEach((meal) => {
            const td = document.createElement('td');
            const select = document.createElement('select');
            select.className = 'form-select';
            select.dataset.day = day;
            select.dataset.meal = meal;

            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '---';
            select.appendChild(emptyOption);

            const filteredRecipes = allRecipes.filter((r) => normalizeKategorija(r.kategorija) === meal);

            filteredRecipes.forEach((r) => {
              const option = document.createElement('option');
              option.value = r.id;
              option.textContent = r.naziv_jela;
              if (savedPlan[day] && savedPlan[day][meal] === r.id) {
                option.selected = true;
              }
              select.appendChild(option);
            });

            td.appendChild(select);
            tr.appendChild(td);
          });

          table.appendChild(tr);
        });
      }

      function saveMealPlan() {
        const selects = document.querySelectorAll('select');
        const plan = {};

        selects.forEach((sel) => {
          const day = sel.dataset.day;
          const meal = sel.dataset.meal;
          const val = sel.value;
          if (!plan[day]) plan[day] = {};
          plan[day][meal] = val;
        });

        localStorage.setItem('weeklyPlan', JSON.stringify(plan));
        saveMsg.classList.remove('d-none');
        setTimeout(() => saveMsg.classList.add('d-none'), 2000);
      }

      function getSavedPlan() {
        const raw = localStorage.getItem('weeklyPlan');
        if (!raw) return {};
        try {
          return JSON.parse(raw);
        } catch {
          return {};
        }
      }

      function generateShoppingList() {
        alert('🛠 Funkcija u izradi – u sledećem koraku pravimo sabranu listu sastojaka!');
      }
    </script>
  </body>
</html>
